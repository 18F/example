{{ $incidents := where .Site.RegularPages "Params.section" "issue" }}
{{ $active := where $incidents "Params.resolved" "=" false }}

{{ $isNotice := where $active "Params.severity" "=" "notice" }}
{{ $isDisrupted := where $active "Params.severity" "=" "disrupted" }}
{{ $isDown := where $active "Params.severity" "=" "down" }}

<button class="usa-accordion__button border shadow-5" aria-controls="{{ .Title }}" aria-expanded="true">
  <a class="usa-button usa-button--secondary" href="{{ .Permalink }}">{{ .Title }}</a>
    <small class="date float-right">
      {{ if .Site.Params.dateFormat }}
        {{ .Date.Format .Site.Params.dateFormat }}
      {{ else }}
        {{ .Date.Format "January 2, 2006 at 3:04 PM" }}
      {{ end }}
    </small>
</button>

<div id="{{ .Title }}" class="usa-accordion__content usa-prose">
  {{ if .Params.informational }}
    {{ .Summary | truncate 500 }}
</div>

  {{ else if .Params.Resolved }}

    {{ $t := (time .Params.ResolvedWhen) }}
    {{ $timeDiff := (sub $t.Unix .Date.Unix) }}
    {{ $diffInMin := (div $timeDiff 60) }}

    <!-- Marker -->
    {{ if lt $timeDiff 60 }}
     <i><b>
     {{ T "resolved" }} {{ T "inUnderAMinute" }}
     </i></b>

     <p>{{ .Summary | truncate 500 }}</p>
    {{ else }}
      {{ if gt $timeDiff 3600 }}

          <i><b>
          {{ T "resolvedAfter" }}
          {{ $minutesForCalc := (mod $diffInMin 60) }}
          {{ div (sub $diffInMin $minutesForCalc) 60 }}h
          {{ $minutesForCalc }}m {{ T "ofDowntime" }}
          </i></b>

          <p>{{ .Summary | truncate 500 }}</p>

      {{ else }}

          <i><b>
          {{ T "resolvedAfter" }}
          {{ $secsForCalc := (mod $timeDiff 60) }}
          {{ div (sub $timeDiff $secsForCalc) 60 }}m
          <!-- {{ $secsForCalc }}s --> 
          {{ T "ofDowntime" }}
          </i></b>
          <p>{{ .Summary | truncate 500 }}</p>

      {{ end }}
    {{ end }}
  {{ else }}

    <small class="date float-right">
      {{ if .Site.Params.dateFormat }}
        {{ .Date.Format .Site.Params.dateFormat }}
      {{ else }}
        {{ .Date.Format "January 2, 2006 at 3:04 PM" }}
      {{ end }}
    </small>

    <h3>
      {{ .Title }}
    </h3>

    <!-- Marker -->
    <strong class="error">
      {{ if eq .Params.severity "down" }}
      ■ 
      {{ else if eq .Params.severity "disrupted" }}
      ▲ 
      {{ else }}
      ◆ 
      {{ end }}
      {{ T "downtimeOngoing" }}</strong>

  {{ end }}
</a>
</div> 